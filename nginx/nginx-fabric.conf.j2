{% macro location(name) -%}
  location /{{ name }}/ {
    proxy_pass https://{{ name }}/;
    proxy_set_header Host {{ name }}{% if internal_domain_name != None %}.{{internal_domain_name}}{% endif %};

    proxy_ssl_session_reuse     on;
    proxy_ssl_protocols         TLSv1.2;
    proxy_ssl_verify            off;
    proxy_read_timeout          3600;
    proxy_connect_timeout       3600;

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Accept-Encoding "";

  }
{%- endmacro %}

error_log /var/log/nginx/error.log debug;
worker_processes  auto;

events {
  worker_connections  1024;
}

daemon off;

http {

    include mime.types;
    include nginx-gz.conf;
    resolver {{ resolver.host }};  #use local DNS and override TTL to whatever value makes sense

    client_max_body_size 30M;
    client_body_buffer_size 30M;
    default_type application/octet-stream;
    access_log /var/log/nginx/access.log combined;

    # use the kernel sendfile
    sendfile        on;
    # prepend http headers before sendfile()
    tcp_nopush      on;
    tcp_nodelay     on;


  {% if services %}
      {% for name, service in services.iteritems() %}
      upstream {{ name }} {
        server          {{ name }}.{{ service.server }}:{{ service.port }};
        zone backend    64k;
        keepalive       300;
      }
      {% endfor %}
  {% endif %}

    server {
        listen 80 default_server;
        server_name {{ name }};
        rewrite_log on;

        keepalive_timeout	3600s;
        keepalive_disable	none;
        keepalive_requests  100000;

        include default-location.conf;


  {% if services %}
    {% for name, service in services.iteritems() %}
      {{ location(name) }}
    {% endfor %}
  {% endif %}

    }
}

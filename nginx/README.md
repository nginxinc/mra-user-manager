# Build Variants
As described in the main [README](../README.md) file, there are three main configuration options that
can be set when building the image.

Among these is the _CONTAINER_ENGINE_ ENV variable in the [Dockerfile](../Dockerfile), which specifies the
container engine for which the image should be built.

## DNS Resolution for Service Discovery

The primary reason for having a configurable container engine is that each of the most popular container engines
includes its own method for assigning DNS records to services running in the engine. NGINX Plus resolves services
by querying DNS SRV records generated by the container engine.

For example, kubernetes creates DNS records for [Service](https://kubernetes.io/docs/concepts/services-networking/service/) 
using a domain which follows the pattern _<port-name>._<protocol>.<service-name>.<namespace>.svc.cluster.local. Given
the following service definition, the DNS SRV record will be: _https._tcp.content-service.nginx-mra.svc.cluster.local

```yaml
apiVersion: v1
kind: Service
metadata:
  name: content-service
  labels:
    app: nginx-mra
    component: content-service
  namespace: nginx-mra
spec:
  type: NodePort
  ports:
  - port: 443
    targetPort: 443
    protocol: TCP
    name: https
  selector:
    app: nginx-mra
    component: content-service
```  

As instances of this service are scaled up and down, NGINX will to consult the DNS SRV records in order to obtain the
IP addresses to which the request should be load balanced.

## Configuration Files
Each of the files below corresponds to a value of the _CONTAINER_ENGINE_ ENV variable. If no value is set or an unrecognized value is used, 
the default is [fabric_config.yaml](fabric_config.yaml) and an image will be created for DC/OS.
- [fabric_config.yaml](fabric_config.yaml): Builds an image for DC/OS
- [fabric_config_docker.yaml](fabric_config_docker.yaml): Builds an image for Docker Cloud
- [fabric_config_k8s.yaml](fabric_config_k8s.yaml): Builds an image for Kubernetes
- [fabric_config_local.yaml](fabric_config_local.yaml): Builds an image for running the MRA on your local machine

## Upstreams
Regardless of which container engine is used, the nginx.conf file will be populated with upstream values represented by
the **services** array in the fabric_config(_k8s|_docker|local).yaml file used to build generate the nginx.conf for the
instance of NGINX which runs on the container and handles requests for the microservice.

The output is a set of upstreams in the nginx.conf file which look like this:
```
...    
    upstream uploader {
        server        marathon.mesos service=_uploader._tcp resolve;
        zone backend  64k;
        least_time 		last_byte;
        keepalive 		300;
    }
    
    upstream user-manager {
        server        marathon.mesos service=_user-manager._tcp resolve;
        zone backend  64k;
        least_time 		last_byte;
        keepalive 		300;
    }
...    
```

You can see a full example [here](nginx-fabric.conf). Note that this is only a sample file; the file used by NGINX is
generated by the [install-nginx.sh](../install-nginx.sh) file.